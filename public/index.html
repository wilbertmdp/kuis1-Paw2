<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRUD Mahasiswa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="text-center mb-4">Manajemen Data Mahasiswa</h2>

    <!-- Form Tambah / Edit -->
    <form id="formMahasiswa" class="mb-4">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="nama" class="form-control" placeholder="Nama Mahasiswa" required>
        </div>
        <div class="col-md-3">
          <input type="text" id="npm" class="form-control" placeholder="NPM" required>
        </div>
        <div class="col-md-3">
          <input type="text" id="jurusan" class="form-control" placeholder="Jurusan" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Tambah</button>
        </div>
      </div>
    </form>

    <!-- ðŸ” Form Pencarian berdasarkan ID -->
    <div class="mb-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <input type="text" id="searchId" class="form-control" placeholder="Cari berdasarkan ID Mahasiswa">
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" onclick="cariById()">Cari</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" onclick="loadData()">Reset</button>
        </div>
      </div>
    </div>

    <!-- Tabel Data -->
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Nama</th>
          <th>NPM</th>
          <th>Jurusan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelMahasiswa"></tbody>
    </table>
  </div>

  <script>
    const apiUrl = "/api/mahasiswa"
    const form = document.getElementById("formMahasiswa")
    const tabel = document.getElementById("tabelMahasiswa")
    let editId = null

    // ðŸ”¹ Menampilkan Semua Data
    async function loadData() {
      const res = await fetch(apiUrl)
      const json = await res.json()
      tabel.innerHTML = ""
      json.data.forEach(mhs => {
        tabel.innerHTML += `
          <tr>
            <td>${mhs.nama}</td>
            <td>${mhs.npm}</td>
            <td>${mhs.jurusan}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="editData('${mhs._id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="hapusData('${mhs._id}')">Hapus</button>
            </td>
          </tr>`
      })
    }

    // ðŸ”¹ Tambah / Update Data
    form.addEventListener("submit", async (e) => {
      e.preventDefault()
      const data = {
        nama: document.getElementById("nama").value,
        npm: document.getElementById("npm").value,
        jurusan: document.getElementById("jurusan").value
      }

      if (editId) {
        await fetch(`${apiUrl}/${editId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        editId = null
      } else {
        await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
      }

      form.reset()
      loadData()
    })

    // ðŸ”¹ Edit Data
    async function editData(id) {
      const res = await fetch(`${apiUrl}/${id}`)
      const json = await res.json()
      const data = json.data

      document.getElementById("nama").value = data.nama
      document.getElementById("npm").value = data.npm
      document.getElementById("jurusan").value = data.jurusan
      editId = id
    }

    // ðŸ”¹ Hapus Data
    async function hapusData(id) {
      if (confirm("Yakin ingin menghapus data ini?")) {
        await fetch(`${apiUrl}/${id}`, { method: "DELETE" })
        loadData()
      }
    }

    // ðŸ”¹ Cari Berdasarkan ID
    async function cariById() {
      const id = document.getElementById("searchId").value.trim()
      if (!id) {
        alert("Masukkan ID mahasiswa terlebih dahulu.")
        return
      }

      try {
        const res = await fetch(`${apiUrl}/${id}`)
        if (!res.ok) {
          alert("Mahasiswa tidak ditemukan.")
          return
        }

        const json = await res.json()
        const data = json.data

        // tampilkan hanya hasil pencarian
        tabel.innerHTML = `
          <tr>
            <td>${data.nama}</td>
            <td>${data.npm}</td>
            <td>${data.jurusan}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="editData('${data._id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="hapusData('${data._id}')">Hapus</button>
            </td>
          </tr>
        `
      } catch (err) {
        alert("Terjadi kesalahan saat mencari data.")
        console.error(err)
      }
    }

    loadData()
  </script>
</body>
</html>
